module imper-repeat where

open import lib

--
-- variable identifiers
--
ğ•€ğ••ğ•–ğ•Ÿ : Set
ğ•€ğ••ğ•–ğ•Ÿ = string

_=ğ•€ğ••ğ•–ğ•Ÿ_ : ğ•€ğ••ğ•–ğ•Ÿ â†’ ğ•€ğ••ğ•–ğ•Ÿ â†’ ğ”¹
_=ğ•€ğ••ğ•–ğ•Ÿ_ = _=string_

--
-- values (just natural numbers here)
--
ğ•ğ•’ğ•ğ•¦ : Set
ğ•ğ•’ğ•ğ•¦ = â„•

--
-- value and variable expressions
--
data ğ”¼ğ•©ğ•¡ğ•Ÿ : Set where
  â‡“_ : ğ•ğ•’ğ•ğ•¦ â†’ ğ”¼ğ•©ğ•¡ğ•Ÿ
  â‡‘_ : ğ•€ğ••ğ•–ğ•Ÿ â†’ ğ”¼ğ•©ğ•¡ğ•Ÿ
  _+ğ•–_ : ğ”¼ğ•©ğ•¡ğ•Ÿ â†’ ğ”¼ğ•©ğ•¡ğ•Ÿ â†’ ğ”¼ğ•©ğ•¡ğ•Ÿ
  _-ğ•–_ : ğ”¼ğ•©ğ•¡ğ•Ÿ â†’ ğ”¼ğ•©ğ•¡ğ•Ÿ â†’ ğ”¼ğ•©ğ•¡ğ•Ÿ
  _*ğ•–_ : ğ•ğ•’ğ•ğ•¦ â†’ ğ”¼ğ•©ğ•¡ğ•Ÿ â†’ ğ”¼ğ•©ğ•¡ğ•Ÿ

--
-- conditions on values and variables
--
data â„‚ğ• ğ•Ÿğ•• : Set where
  â‡“true : â„‚ğ• ğ•Ÿğ••
  â‡“false : â„‚ğ• ğ•Ÿğ••
  _âˆ§ğ•”_ : â„‚ğ• ğ•Ÿğ•• â†’ â„‚ğ• ğ•Ÿğ•• â†’ â„‚ğ• ğ•Ÿğ••
  _âˆ¨ğ•”_ : â„‚ğ• ğ•Ÿğ•• â†’ â„‚ğ• ğ•Ÿğ•• â†’ â„‚ğ• ğ•Ÿğ••
  Â¬ğ•”_ : â„‚ğ• ğ•Ÿğ•• â†’ â„‚ğ• ğ•Ÿğ••
  _<ğ•”_ : ğ”¼ğ•©ğ•¡ğ•Ÿ â†’ ğ”¼ğ•©ğ•¡ğ•Ÿ â†’ â„‚ğ• ğ•Ÿğ••
  _=ğ•”_ : ğ”¼ğ•©ğ•¡ğ•Ÿ â†’ ğ”¼ğ•©ğ•¡ğ•Ÿ â†’ â„‚ğ• ğ•Ÿğ••

--
-- stack frames containing variable bindings
--
ğ”½ğ•£ğ•ğ•– : Set
ğ”½ğ•£ğ•ğ•– = ğ•ƒ (ğ•€ğ••ğ•–ğ•Ÿ Ã— ğ•ğ•’ğ•ğ•¦)

[-â†¦0] : ğ”½ğ•£ğ•ğ•–
[-â†¦0] = []

_â†¦_ : ğ•€ğ••ğ•–ğ•Ÿ â†’ ğ•ğ•’ğ•ğ•¦ â†’ ğ•€ğ••ğ•–ğ•Ÿ Ã— ğ•ğ•’ğ•ğ•¦
ğ’™ â†¦ ğ“‹ = (ğ’™ , ğ“‹)

--
-- program statements that transform a frame
--
data ğ•Šğ•¥ğ•ğ•¥ : Set where
  skip : ğ•Šğ•¥ğ•ğ•¥
  _âˆ·=_ : ğ•€ğ••ğ•–ğ•Ÿ â†’ ğ”¼ğ•©ğ•¡ğ•Ÿ â†’ ğ•Šğ•¥ğ•ğ•¥
  _â†©_ : ğ•Šğ•¥ğ•ğ•¥ â†’ ğ•Šğ•¥ğ•ğ•¥ â†’Â ğ•Šğ•¥ğ•ğ•¥
  if_then_else_end : â„‚ğ• ğ•Ÿğ•• â†’ ğ•Šğ•¥ğ•ğ•¥ â†’ ğ•Šğ•¥ğ•ğ•¥ â†’ ğ•Šğ•¥ğ•ğ•¥
  by_repeat_end : ğ•€ğ••ğ•–ğ•Ÿ â†’ ğ•Šğ•¥ğ•ğ•¥ â†’ ğ•Šğ•¥ğ•ğ•¥
  returns : ğ”¼ğ•©ğ•¡ğ•Ÿ â†’ ğ•Šğ•¥ğ•ğ•¥

infix 11 â‡‘_ â‡“_
infixr 10 _*ğ•–_
infixl 9 _+ğ•–_ _-ğ•–_
infix 8 _=ğ•”_ _<ğ•”_
infix 7 Â¬ğ•”_
infixl 6 _âˆ¨ğ•”_
infixl 5 _âˆ§ğ•”_
infix 4 _âˆ·=_
infix 3 returns
infixl 2 _â†©_

--
-- functional SEMANTICS of frames
--

lookup : ğ•€ğ••ğ•–ğ•Ÿ â†’ ğ”½ğ•£ğ•ğ•– â†’ ğ•ğ•’ğ•ğ•¦
lookup ğ’™ [] = 0
lookup ğ’™ ((ğ’š , ğ“Œ) :: â„±) = if (ğ’™ =ğ•€ğ••ğ•–ğ•Ÿ ğ’š) then ğ“Œ else (lookup ğ’™ â„±)

_âˆ£_â†¦_ : ğ”½ğ•£ğ•ğ•– â†’ ğ•€ğ••ğ•–ğ•Ÿ â†’ ğ•ğ•’ğ•ğ•¦ â†’ ğ”½ğ•£ğ•ğ•–
[] âˆ£ ğ’™ â†¦ ğ“‹ = [ ğ’™ â†¦ ğ“‹ ]
((ğ’š , ğ“Œ) :: â„±) âˆ£ ğ’™ â†¦ ğ“‹ = if (ğ’™ =ğ•€ğ••ğ•–ğ•Ÿ ğ’š)
                              then (ğ’š â†¦ ğ“‹) :: â„±
                              else (ğ’š â†¦ ğ“Œ) :: (â„± âˆ£ ğ’™ â†¦ ğ“‹)

--
-- functional SEMANTICS of expressions
--
âŸ¦_âŸ§ğ•–_ : ğ”¼ğ•©ğ•¡ğ•Ÿ â†’ ğ”½ğ•£ğ•ğ•– â†’ ğ•ğ•’ğ•ğ•¦
âŸ¦ (â‡“ ğ“‹) âŸ§ğ•– _ = ğ“‹
âŸ¦ (â‡‘ ğ’™) âŸ§ğ•– â„± = lookup ğ’™ â„±
âŸ¦ â„¯â‚ +ğ•– â„¯â‚‚ âŸ§ğ•– â„± = (âŸ¦ â„¯â‚ âŸ§ğ•– â„±) + (âŸ¦ â„¯â‚‚ âŸ§ğ•– â„±)
âŸ¦ â„¯â‚ -ğ•– â„¯â‚‚ âŸ§ğ•– â„± = (âŸ¦ â„¯â‚ âŸ§ğ•– â„±) âˆ¸ (âŸ¦ â„¯â‚‚ âŸ§ğ•– â„±)
âŸ¦ ğ“‹â‚ *ğ•– â„¯â‚‚ âŸ§ğ•– â„± = ğ“‹â‚ * (âŸ¦ â„¯â‚‚ âŸ§ğ•– â„±)

--
-- functional SEMANTICS of conditions
--
âŸ¦_âŸ§ğ•”_ : â„‚ğ• ğ•Ÿğ•• â†’ ğ”½ğ•£ğ•ğ•– â†’ ğ”¹
âŸ¦ â‡“true âŸ§ğ•” _ = tt
âŸ¦ â‡“false âŸ§ğ•” _ = ff
âŸ¦ ğ’¸â‚ âˆ§ğ•” ğ’¸â‚‚ âŸ§ğ•” â„± = (âŸ¦ ğ’¸â‚ âŸ§ğ•” â„±) && (âŸ¦ ğ’¸â‚‚ âŸ§ğ•” â„±)
âŸ¦ ğ’¸â‚ âˆ¨ğ•” ğ’¸â‚‚ âŸ§ğ•” â„± = (âŸ¦ ğ’¸â‚ âŸ§ğ•” â„±) || (âŸ¦ ğ’¸â‚‚ âŸ§ğ•” â„±)
âŸ¦ Â¬ğ•” ğ’¸ âŸ§ğ•” â„± = ~ (âŸ¦ ğ’¸ âŸ§ğ•” â„±)
âŸ¦ â„¯â‚ <ğ•” â„¯â‚‚ âŸ§ğ•” â„± = (âŸ¦ â„¯â‚ âŸ§ğ•– â„±) < (âŸ¦ â„¯â‚‚ âŸ§ğ•– â„±)
âŸ¦ â„¯â‚ =ğ•” â„¯â‚‚ âŸ§ğ•” â„± = (âŸ¦ â„¯â‚ âŸ§ğ•– â„±) =â„• (âŸ¦ â„¯â‚‚ âŸ§ğ•– â„±)

repeatedly : ğ•€ğ••ğ•–ğ•Ÿ â†’ â„• â†’ ğ•Šğ•¥ğ•ğ•¥ â†’ ğ”½ğ•£ğ•ğ•– â†’ ğ”½ğ•£ğ•ğ•–
âŸ¦_âŸ§ğ•¤_ : ğ•Šğ•¥ğ•ğ•¥ â†’ ğ”½ğ•£ğ•ğ•– â†’ ğ”½ğ•£ğ•ğ•–
repeatedly ğ’™ 0 ğ“ˆ â„± = â„±
repeatedly ğ’™ (suc n) ğ“ˆ â„± = repeatedly ğ’™ n ğ“ˆ ((âŸ¦ ğ“ˆ âŸ§ğ•¤ â„±) âˆ£ ğ’™ â†¦ n )
âŸ¦ skip âŸ§ğ•¤ â„± = â„±
âŸ¦ ğ’™ âˆ·= â„¯ âŸ§ğ•¤ â„± = (â„± âˆ£ ğ’™ â†¦ (âŸ¦ â„¯ âŸ§ğ•– â„±))
âŸ¦ ğ“ˆâ‚ â†© ğ“ˆâ‚‚ âŸ§ğ•¤ â„± = (âŸ¦ ğ“ˆâ‚‚ âŸ§ğ•¤ (âŸ¦ ğ“ˆâ‚ âŸ§ğ•¤ â„±))
âŸ¦ if ğ’¸ then ğ“ˆâ‚ else ğ“ˆâ‚‚ end âŸ§ğ•¤ â„± = if (âŸ¦ ğ’¸ âŸ§ğ•” â„±) then (âŸ¦ ğ“ˆâ‚ âŸ§ğ•¤ â„±) else (âŸ¦ ğ“ˆâ‚‚ âŸ§ğ•¤ â„±)
âŸ¦ by ğ’™ repeat ğ“ˆ end âŸ§ğ•¤ â„± = repeatedly ğ’™ (âŸ¦ â‡‘ ğ’™ âŸ§ğ•– â„±) ğ“ˆ â„±
âŸ¦ returns â„¯ âŸ§ğ•¤ â„± = â„± âˆ£ "retval" â†¦ (âŸ¦ â„¯ âŸ§ğ•– â„±)

arg1 : ğ•€ğ••ğ•–ğ•Ÿ
arg1 = "arg1"

arg2 : ğ•€ğ••ğ•–ğ•Ÿ
arg2 = "arg2"

retval : ğ•€ğ••ğ•–ğ•Ÿ
retval = "retval"

W : ğ•€ğ••ğ•–ğ•Ÿ
W = "w"

X : ğ•€ğ••ğ•–ğ•Ÿ
X = "x"

Y : ğ•€ğ••ğ•–ğ•Ÿ
Y = "y"

Z : ğ•€ğ••ğ•–ğ•Ÿ
Z = "z"

pgm0 : ğ•Šğ•¥ğ•ğ•¥
pgm0 = X âˆ·= â‡“ 3 â†©
       Y âˆ·= â‡“ 1 â†©
       Y âˆ·= 2 *ğ•– â‡‘ Y

pgm1 : ğ•Šğ•¥ğ•ğ•¥
pgm1 = X âˆ·= â‡“ 3 â†©
       Y âˆ·= â‡“ 1 â†©
       by X repeat
         Y âˆ·= 2 *ğ•– â‡‘ Y
       end

Zâˆ·=X*Y = W âˆ·= â‡‘ X â†©
         Z âˆ·= â‡“ 0 â†©
         by W repeat
           Z âˆ·= â‡‘ Z +ğ•– â‡‘ Y
         end


pgm2 = X âˆ·= â‡“ 3 â†©
       Y âˆ·= â‡“ 1 â†©
       by X repeat
         Zâˆ·=X*Y â†©
         Y âˆ·= â‡‘ Z
       end


fact-pgm : ğ•Šğ•¥ğ•ğ•¥
fact-pgm =
  (X âˆ·= (â‡‘ arg1)) â†©
  (Y âˆ·= (â‡“ 1)) â†©
  (by X repeat (
    Zâˆ·=X*Y â†©
    (Y âˆ·= (â‡‘ Z)))
  end) â†©
  (returns (â‡‘ Y))


result1 = âŸ¦ pgm1 âŸ§ğ•¤ [-â†¦0]
result2 = âŸ¦ pgm2 âŸ§ğ•¤ [-â†¦0]


--
-- SEMANTICS of stack bindings as a relation
--

data _âŠ¢_â†¦_ : ğ”½ğ•£ğ•ğ•– â†’ ğ•€ğ••ğ•–ğ•Ÿ â†’ ğ•ğ•’ğ•ğ•¦ â†’ Set where

  var-undef : âˆ€ {ğ’™ : ğ•€ğ••ğ•–ğ•Ÿ}
              ----------------
              â†’ [] âŠ¢ ğ’™ â†¦ 0

  var-match : âˆ€ {ğ’™ : ğ•€ğ••ğ•–ğ•Ÿ} {â„± : ğ”½ğ•£ğ•ğ•–} {ğ“‹ : ğ•ğ•’ğ•ğ•¦}
              ---------------------------
              â†’ ((ğ’™ , ğ“‹) :: â„±) âŠ¢ ğ’™ â†¦ ğ“‹

  var-mismatch : âˆ€ {ğ’™ ğ’š : ğ•€ğ••ğ•–ğ•Ÿ} {â„± : ğ”½ğ•£ğ•ğ•–} {ğ“‹ ğ“Œ : ğ•ğ•’ğ•ğ•¦}
                 â†’ (ğ’™ =string ğ’š) â‰¢ ff
                 â†’ â„± âŠ¢ ğ’™ â†¦ ğ“‹
                 -------------------------
                 â†’ ((ğ’š , ğ“Œ) :: â„±) âŠ¢ ğ’™ â†¦ ğ“‹

--
-- SEMANTICS of expression evaluation as a relation
--

data _âŠ¢_â‡“_ : ğ”½ğ•£ğ•ğ•– â†’ ğ”¼ğ•©ğ•¡ğ•Ÿ â†’ ğ•ğ•’ğ•ğ•¦ â†’ Set where

  ğ•–-const : âˆ€ {ğ“‹ : ğ•ğ•’ğ•ğ•¦} {â„± : ğ”½ğ•£ğ•ğ•–}
            ----------------
            â†’ â„± âŠ¢ (â‡“ ğ“‹) â‡“ ğ“‹

  ğ•–-var : âˆ€ {ğ’™ : ğ•€ğ••ğ•–ğ•Ÿ} {â„± : ğ”½ğ•£ğ•ğ•–} {ğ“‹ : ğ•ğ•’ğ•ğ•¦}
          â†’ â„± âŠ¢ ğ’™ â†¦ ğ“‹
          ---------------
          â†’ â„± âŠ¢ (â‡‘ ğ’™) â‡“ ğ“‹

  ğ•–-sum : âˆ€ {â„¯â‚ â„¯â‚‚ : ğ”¼ğ•©ğ•¡ğ•Ÿ} {â„± : ğ”½ğ•£ğ•ğ•–} {ğ“‹â‚ ğ“‹â‚‚ : ğ•ğ•’ğ•ğ•¦}
                            â†’ â„± âŠ¢ â„¯â‚ â‡“ ğ“‹â‚
                            â†’ â„± âŠ¢ â„¯â‚‚ â‡“ ğ“‹â‚‚
                            ---------------------------
                            â†’ â„± âŠ¢ (â„¯â‚ +ğ•– â„¯â‚‚) â‡“ (ğ“‹â‚ + ğ“‹â‚‚)

  ğ•–-sub : âˆ€ {â„¯â‚ â„¯â‚‚ : ğ”¼ğ•©ğ•¡ğ•Ÿ} {â„± : ğ”½ğ•£ğ•ğ•–} {ğ“‹â‚ ğ“‹â‚‚ : ğ•ğ•’ğ•ğ•¦}
                            â†’ â„± âŠ¢ â„¯â‚ â‡“ ğ“‹â‚
                            â†’ â„± âŠ¢ â„¯â‚‚ â‡“ ğ“‹â‚‚
                            ---------------------------
                            â†’ â„± âŠ¢ (â„¯â‚ -ğ•– â„¯â‚‚) â‡“ (ğ“‹â‚ âˆ¸ ğ“‹â‚‚)

  ğ•–-mul : âˆ€ {â„¯â‚‚ : ğ”¼ğ•©ğ•¡ğ•Ÿ} {â„± : ğ”½ğ•£ğ•ğ•–} {ğ“‹â‚ ğ“‹â‚‚ : ğ•ğ•’ğ•ğ•¦}
                            â†’ â„± âŠ¢ â„¯â‚‚ â‡“ ğ“‹â‚‚
                            ---------------------------
                            â†’ â„± âŠ¢ (ğ“‹â‚ *ğ•– â„¯â‚‚) â‡“ (ğ“‹â‚ * ğ“‹â‚‚)


postulate
  thm-ğ•– :  âˆ€ {â„¯ : ğ”¼ğ•©ğ•¡ğ•Ÿ} {â„± : ğ”½ğ•£ğ•ğ•–} â†’ â„± âŠ¢ â„¯ â‡“ (âŸ¦ â„¯ âŸ§ğ•– â„±)


--
-- SEMANTICS of conditions as a decidable relation
--

data _âŠ¢_ : ğ”½ğ•£ğ•ğ•– â†’ â„‚ğ• ğ•Ÿğ•• â†’ Set
data _âŠ¬_ : ğ”½ğ•£ğ•ğ•– â†’ â„‚ğ• ğ•Ÿğ•• â†’ Set

data _âŠ¢_ where

  ğ•”-tt :  âˆ€ {â„± : ğ”½ğ•£ğ•ğ•–}
          -----------
          â†’ â„± âŠ¢ â‡“true

  ğ•”-and : âˆ€ {ğ’¸â‚ ğ’¸â‚‚ : â„‚ğ• ğ•Ÿğ••} {â„± : ğ”½ğ•£ğ•ğ•–}
          â†’ â„± âŠ¢ ğ’¸â‚
          â†’ â„± âŠ¢ ğ’¸â‚‚
          ---------------
          â†’ â„± âŠ¢ (ğ’¸â‚ âˆ§ğ•” ğ’¸â‚‚)

  ğ•”-orâ‚ : âˆ€ {ğ’¸â‚ ğ’¸â‚‚ : â„‚ğ• ğ•Ÿğ••} {â„± : ğ”½ğ•£ğ•ğ•–}
          â†’ â„± âŠ¢ ğ’¸â‚
          ---------------
          â†’ â„± âŠ¢ (ğ’¸â‚ âˆ¨ğ•” ğ’¸â‚‚)

  ğ•”-orâ‚‚ : âˆ€ {ğ’¸â‚ ğ’¸â‚‚ : â„‚ğ• ğ•Ÿğ••} {â„± : ğ”½ğ•£ğ•ğ•–}
          â†’ â„± âŠ¢ ğ’¸â‚‚
          ---------------
          â†’ â„± âŠ¢ (ğ’¸â‚ âˆ¨ğ•” ğ’¸â‚‚)

  ğ•”-less : âˆ€ {â„¯â‚ â„¯â‚‚ : ğ”¼ğ•©ğ•¡ğ•Ÿ} {â„± : ğ”½ğ•£ğ•ğ•–} {ğ“‹â‚ ğ“‹â‚‚ : ğ•ğ•’ğ•ğ•¦}
           â†’ ğ“‹â‚ < ğ“‹â‚‚ â‰¡ tt
           â†’ â„± âŠ¢ â„¯â‚ â‡“ ğ“‹â‚
           â†’ â„± âŠ¢ â„¯â‚‚ â‡“ ğ“‹â‚‚
           ----------------
           â†’ â„± âŠ¢ (â„¯â‚ <ğ•” â„¯â‚‚)

  ğ•”-eq : âˆ€ {â„¯â‚ â„¯â‚‚ : ğ”¼ğ•©ğ•¡ğ•Ÿ} {â„± : ğ”½ğ•£ğ•ğ•–} {ğ“‹ : ğ•ğ•’ğ•ğ•¦}
           â†’ â„± âŠ¢ â„¯â‚ â‡“ ğ“‹
           â†’ â„± âŠ¢ â„¯â‚‚ â‡“ ğ“‹
           ----------------
           â†’ â„± âŠ¢ (â„¯â‚ =ğ•” â„¯â‚‚)

  ğ•”-not : âˆ€ {ğ’¸ : â„‚ğ• ğ•Ÿğ••} {â„± : ğ”½ğ•£ğ•ğ•–}
          â†’ â„± âŠ¬ ğ’¸
          ----------------
          â†’ â„± âŠ¢ (Â¬ğ•” ğ’¸)


data _âŠ¬_ where

  ~ğ•”-ff :  âˆ€ {â„± : ğ”½ğ•£ğ•ğ•–}
           ------------
           â†’ â„± âŠ¬ â‡“false

  ~ğ•”-or : âˆ€ {ğ’¸â‚ ğ’¸â‚‚ : â„‚ğ• ğ•Ÿğ••} {â„± : ğ”½ğ•£ğ•ğ•–}
          â†’ â„± âŠ¬ ğ’¸â‚
          â†’ â„± âŠ¬ ğ’¸â‚‚
          -------------
          â†’ â„± âŠ¬ (ğ’¸â‚ âˆ¨ğ•” ğ’¸â‚‚)

  ~ğ•”-andâ‚ : âˆ€ {ğ’¸â‚ ğ’¸â‚‚ : â„‚ğ• ğ•Ÿğ••} {â„± : ğ”½ğ•£ğ•ğ•–}
            â†’ â„± âŠ¬ ğ’¸â‚
            -------------
            â†’ â„± âŠ¬ (ğ’¸â‚ âˆ§ğ•” ğ’¸â‚‚)

  ~ğ•”-andâ‚‚ : âˆ€ {ğ’¸â‚ ğ’¸â‚‚ : â„‚ğ• ğ•Ÿğ••} {â„± : ğ”½ğ•£ğ•ğ•–}
            â†’ â„± âŠ¬ ğ’¸â‚‚
            -------------
            â†’ â„± âŠ¬ (ğ’¸â‚ âˆ§ğ•” ğ’¸â‚‚)

  ~ğ•”-eq : âˆ€ {â„¯â‚ â„¯â‚‚ : ğ”¼ğ•©ğ•¡ğ•Ÿ} {â„± : ğ”½ğ•£ğ•ğ•–} {ğ“‹â‚ ğ“‹â‚‚ : ğ•ğ•’ğ•ğ•¦}
            â†’ ğ“‹â‚ =â„• ğ“‹â‚‚ â‰¡ ff
            â†’ â„± âŠ¢ â„¯â‚ â‡“ ğ“‹â‚
            â†’ â„± âŠ¢ â„¯â‚‚ â‡“ ğ“‹â‚‚
            ----------------
            â†’ â„± âŠ¬ (â„¯â‚ =ğ•” â„¯â‚‚)

  ~ğ•”-less : âˆ€ {â„¯â‚ â„¯â‚‚ : ğ”¼ğ•©ğ•¡ğ•Ÿ} {â„± : ğ”½ğ•£ğ•ğ•–} {ğ“‹â‚ ğ“‹â‚‚ : ğ•ğ•’ğ•ğ•¦}
            â†’ ğ“‹â‚ < ğ“‹â‚‚ â‰¡ ff
            â†’ â„± âŠ¢ â„¯â‚ â‡“ ğ“‹â‚
            â†’ â„± âŠ¢ â„¯â‚‚ â‡“ ğ“‹â‚‚
            ----------------
            â†’ â„± âŠ¬ (â„¯â‚ <ğ•” â„¯â‚‚)

  ~ğ•”-not : âˆ€ {ğ’¸ : â„‚ğ• ğ•Ÿğ••} {â„± : ğ”½ğ•£ğ•ğ•–}
           â†’ â„± âŠ¢ ğ’¸
           ----------------
           â†’ â„± âŠ¬ (Â¬ğ•” ğ’¸)

test3 : [] âŠ¢ (â‡“true âˆ§ğ•” (Â¬ğ•” â‡“false))
test3 = ğ•”-and ğ•”-tt (ğ•”-not ~ğ•”-ff)

postulate
  thm-ğ•”â†’ :  âˆ€ {ğ’¸ : â„‚ğ• ğ•Ÿğ••}  {â„± : ğ”½ğ•£ğ•ğ•–} â†’ â„± âŠ¢ ğ’¸ â†’ (âŸ¦ ğ’¸ âŸ§ğ•” â„± â‰¡ tt)
  thm-~ğ•”â†’ :  âˆ€ {ğ’¸ : â„‚ğ• ğ•Ÿğ••}  {â„± : ğ”½ğ•£ğ•ğ•–} â†’ â„± âŠ¬ ğ’¸ â†’ (âŸ¦ ğ’¸ âŸ§ğ•” â„± â‰¡ ff)


--
-- SEMANTICS of program statements as a state transformation relation
--

data _=[_]â‡’_ : ğ”½ğ•£ğ•ğ•– â†’ ğ•Šğ•¥ğ•ğ•¥ â†’ ğ”½ğ•£ğ•ğ•– â†’ Set where

 ğ•¤-skip : âˆ€ {â„± : ğ”½ğ•£ğ•ğ•–}
          --------------
          â†’ â„± =[ skip ]â‡’ â„±

 ğ•¤-assign : âˆ€ {ğ’™ : ğ•€ğ••ğ•–ğ•Ÿ} {â„¯ : ğ”¼ğ•©ğ•¡ğ•Ÿ} {â„± : ğ”½ğ•£ğ•ğ•–}  {ğ“‹ : ğ•ğ•’ğ•ğ•¦}
            â†’ â„± âŠ¢ â„¯ â‡“ ğ“‹
            ------------------------------
            â†’ â„± =[ ğ’™ âˆ·= â„¯ ]â‡’ (â„± âˆ£ ğ’™ â†¦ ğ“‹)

 ğ•¤-seq : âˆ€ {ğ“ˆâ‚ ğ“ˆâ‚‚ : ğ•Šğ•¥ğ•ğ•¥} {â„±â‚€ â„±â‚ â„±â‚‚ : ğ”½ğ•£ğ•ğ•–}
         â†’ â„±â‚€ =[ ğ“ˆâ‚ ]â‡’ â„±â‚
         â†’ â„±â‚ =[ ğ“ˆâ‚‚ ]â‡’ â„±â‚‚
         -------------------
         â†’ â„±â‚€ =[ ğ“ˆâ‚ â†© ğ“ˆâ‚‚ ]â‡’ â„±â‚‚

 ğ•¤-if-then : âˆ€ {ğ’¸ : â„‚ğ• ğ•Ÿğ••} {ğ“ˆâ‚ ğ“ˆâ‚‚ : ğ•Šğ•¥ğ•ğ•¥} {â„± â„±' : ğ”½ğ•£ğ•ğ•–}
             â†’ â„± âŠ¢ ğ’¸
             â†’ â„± =[ ğ“ˆâ‚ ]â‡’ â„±'
             â†’ â„± =[ ğ“ˆâ‚‚ ]â‡’ â„±'
             -------------------
             â†’ â„± =[ if ğ’¸ then ğ“ˆâ‚ else ğ“ˆâ‚‚ end ]â‡’ â„±'

 ğ•¤-if-else : âˆ€ {ğ’¸ : â„‚ğ• ğ•Ÿğ••} {ğ“ˆâ‚ ğ“ˆâ‚‚ : ğ•Šğ•¥ğ•ğ•¥} {â„± â„±' : ğ”½ğ•£ğ•ğ•–}
             â†’ â„± âŠ¬ ğ’¸
             â†’ â„± =[ ğ“ˆâ‚‚ ]â‡’ â„±'
             -------------------
             â†’ â„± =[ if ğ’¸ then ğ“ˆâ‚ else ğ“ˆâ‚‚ end ]â‡’ â„±'

 ğ•¤-repeat-0 : âˆ€ {ğ“ˆ : ğ•Šğ•¥ğ•ğ•¥} {ğ’™ : ğ•€ğ••ğ•–ğ•Ÿ} {â„± : ğ”½ğ•£ğ•ğ•–}
             â†’ â„± âŠ¢ (â‡‘ ğ’™) â‡“ 0
             -------------------------
             â†’ â„± =[ by ğ’™ repeat ğ“ˆ end ]â‡’ â„±

 ğ•¤-repeat-suc : âˆ€ {n : â„•} {ğ“ˆ : ğ•Šğ•¥ğ•ğ•¥} {ğ’™ : ğ•€ğ••ğ•–ğ•Ÿ} {â„± â„±' : ğ”½ğ•£ğ•ğ•–}
                â†’ â„± âŠ¢ (â‡‘ ğ’™) â‡“ suc n
                â†’ â„± =[ ğ“ˆ â†© ğ’™ âˆ·= (â‡“ n) â†© by ğ’™ repeat ğ“ˆ end ]â‡’ â„±'
                -------------------------------------------
                â†’ â„± =[ by ğ’™ repeat ğ“ˆ end ]â‡’ â„±'

 -- I've cheated and treated "return" as an assignment, no jump out

 ğ•¤-return : âˆ€ {â„¯ : ğ”¼ğ•©ğ•¡ğ•Ÿ} {â„± : ğ”½ğ•£ğ•ğ•–}  {ğ“‹ : ğ•ğ•’ğ•ğ•¦}
            â†’ â„± âŠ¢ â„¯ â‡“ ğ“‹
            ------------------------------
            â†’ â„± =[ returns â„¯ ]â‡’ (â„± âˆ£ "retval" â†¦ ğ“‹)

[âŠâ†¦_] : ğ•ğ•’ğ•ğ•¦ â†’ ğ”½ğ•£ğ•ğ•–
[âŠâ†¦ ğ“‹ ] = [-â†¦0] âˆ£ arg1 â†¦ ğ“‹

[âŠâ†¦_,â‹â†¦_] : ğ•ğ•’ğ•ğ•¦ â†’  ğ•ğ•’ğ•ğ•¦ â†’ ğ”½ğ•£ğ•ğ•–
[âŠâ†¦ ğ“‹â‚ ,â‹â†¦ ğ“‹â‚‚ ] = (([-â†¦0] âˆ£ arg1 â†¦ ğ“‹â‚) âˆ£ arg2 â†¦ ğ“‹â‚‚ )

frame6 = (((((([-â†¦0] âˆ£ arg1 â†¦ 3) âˆ£ X â†¦ 0) âˆ£ Y â†¦ 6) âˆ£ W â†¦ 0) âˆ£ Z â†¦ 6) âˆ£ retval â†¦ 6)
postulate
  test6 : [âŠâ†¦ 3 ] =[ fact-pgm ]â‡’ frame6


postulate
  thm-ğ•¤ : âˆ€ {ğ“ˆ : ğ•Šğ•¥ğ•ğ•¥ } {â„± : ğ”½ğ•£ğ•ğ•–} â†’ â„± =[ ğ“ˆ ]â‡’ (âŸ¦ ğ“ˆ âŸ§ğ•¤ â„±)

postulate
  thm-! : âˆ€ {n : â„•} {â„± : ğ”½ğ•£ğ•ğ•–} â†’ [âŠâ†¦ n ] =[ fact-pgm ]â‡’ â„± â†’ â„± âŠ¢ retval â†¦ (factorial n)
